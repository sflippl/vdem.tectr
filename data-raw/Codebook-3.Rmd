---
title: "Geocoding"
author: "Samuel Lippl"
date: "12 September 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(cshapes)
library(sf)
library(tidyverse)
library(lubridate)
library(magrittr)
devtools::load_all()
```

This document geocodes the countries in the V-DEM dataset beginning in 1946. We therefore extract the necessary part of the dataset:

```{r}
df_geocode <- 
  df_vdem %>% 
  filter(year >= 1946) %>% 
  select(country_name, COWcode) %>% 
  unique()
df_geocode
```

Of course, country borders change. This is where the package `cshapes` is helpful.

```{r}
cshp <- 
  cshp() %>% 
  st_as_sf()
head(cshp)
```

We only need the COW Codes, not the GW Codes. "COWSYEAR" refers to the first year of coding and COWEYEAR of coding. As we need years, we will refer to the old borders if the coding ends after the 1st January of the corresponding year:

```{r}
cshp <- 
  cshp %>% 
  transmute(country = CNTRY_NAME, 
            cow_code = as.numeric(COWCODE), 
            start_year = if_else(
              COWSMONTH == 1 & COWSDAY == 1, 
              as.numeric(COWSYEAR), 
              COWSYEAR + 1
            ), 
            end_year = if_else(
              COWEMONTH == 1 & COWEDAY == 1, 
              COWEYEAR - 1, 
              as.numeric(COWEYEAR)
            ))
cshp
```

Furthermore, I extend the `end_year` column to 2017 so that the latest year of V-DEM data can be included.

```{r}
cshp <- 
  cshp %>% 
  mutate(end_year = if_else(end_year == 2016, 2017, end_year))
```

We can now join the two data frames:

```{r}
cow_geocode <- 
  cshp %>% 
  inner_join(df_geocode, by = c("cow_code" = "COWcode"))
cow_geocode %>%
  unique()
```

We also retain the rows in `cshp` and `df_geocode` that could not be matched:

```{r}
vdem_rem <- 
  df_geocode %>% 
  anti_join(cshp, by = c("COWcode" = "cow_code"))
cshp_rem <- 
  cshp %>% 
  anti_join(df_geocode, by = c("cow_code" = "COWcode"))
```

```{r}
vdem_rem %>% 
  unique()
```

The COWcode for all remaining countries is 99999 which probably encodes `NA`.

```{r}
cshp_rem %>% 
  as_tibble %>% 
  select(-geometry) %>% 
  print(n = 31)
```

A quick inspection demonstrates that `cshp_rem` is not of use (the USSR and Yugoslavia observations are only encoded for the GW borders for these intervals).

We therefore need to employ a different strategy for this part of the geocoding. The Natural Earth dataset will come in handy.

## Zanzibar

According the COW, Zanzibar has only been an independent state in 1964 and belongs to Tanzania (which is the official stance). However, V-DEM codes the country as independent from 1964 until the present (remark: for now, due to consistency, I will code it as such from 1965 until the present, as the change in the COW code only sets in after the 1st January 1964).

```{r}
tanzania_62_64 <- 
  cshp %>% 
  filter(country == "Tanzania", end_year <= 1964) %>% 
  select(geometry) %>% 
  unique() %>%
  extract2("geometry")
zanzibar <- 
  cshp %>% 
  filter(country == "Zanzibar") %>% 
  extract2("geometry")
tanzania_65_96 <- 
  cshp %>% 
  filter(country == "Tanzania", start_year >= 1965, end_year == 1996) %>% 
  extract2("geometry")
tanzania_97_ <- 
  cshp %>% 
  filter(country == "Tanzania", start_year == 1997) %>% 
  extract2("geometry")
df_ts <- st_sf(
  timespan = c("1962 - 1964", "1962 - 1964", 
               "1965 - 1996", "1965 - 1996", 
               "1996 - 2017", "1996 - 2017"), 
  country = rep(c("Tanzania", "Zanzibar"), 3), 
  geometry = c(tanzania_62_64, zanzibar, 
               tanzania_65_96, zanzibar, 
               tanzania_97_, zanzibar)
)
ggplot(df_ts) + 
  geom_sf(alpha = .5) + 
  facet_grid(vars(timespan), vars(country))
```

We therefore need to subtract zanzibar from tanzania after 1965:

```{r}
tanzania_65_96 <- 
  tanzania_65_96 %>%
  st_difference(zanzibar)
tanzania_97_ <-
  tanzania_97_ %>% 
  st_difference(zanzibar)
df_ts <- st_sf(
  timespan = c("1962 - 1964", "1962 - 1964", 
               "1965 - 1996", "1965 - 1996", 
               "1997 - 2017", "1997 - 2017"), 
  country = rep(c("Tanzania", "Zanzibar"), 3), 
  geometry = c(tanzania_62_64, zanzibar, 
               tanzania_65_96, zanzibar, 
               tanzania_97_, zanzibar)
)
ggplot(df_ts) + 
  geom_sf(alpha = .5) + 
  facet_grid(vars(timespan), vars(country))
df_ts %>% 
  filter(timespan == "1965 - 1996") %>% 
  ggplot(aes(fill = country)) + 
  geom_sf(alpha = .5) 
```

It can be clearly seen here that our operation was successful.

```{r}
cow_geocode <-
  cow_geocode %>% 
  filter(!(country_name == "Tanzania" & start_year >= 1965)) %>% 
  rbind(
    st_sf(
      country = c("Tanzania", "Tanzania", "Zanzibar"), 
      country_name = c("Tanzania", "Tanzania", "Zanzibar"), 
      cow_code = c(510, 510, NA_integer_), 
      start_year = c(1965, 1997, 1962), 
      end_year = c(1996, 2017, 2017), 
      geometry = c(tanzania_65_96, tanzania_97_, zanzibar)
    ) %>% 
      st_transform(crs = st_crs(cow_geocode))
  )
```

## Somalia

```{r}
countries <- read_sf(
  system.file(
    "extdata", 
    "natural_earth/ne_110m_admin_0_sovereignty.shp",
    package = "vdem.tectr"
  )
) %>% 
  st_transform(st_crs(cshp))
```

Somaliland does not exist in `cshp` and we therefore extract it from the [https://www.naturalearthdata.com/](Natural Earth data).
[https://www.bbc.com/news/world-africa-14115069](Somaliland) declared independence in 1991 and is coded as a country by the V-Dem since.

```{r}
somaliland <- 
  countries %>% 
  filter(SOVEREIGNT == "Somaliland") %>% 
  extract2("geometry")
somalia <- 
  cshp %>%
  filter(country == "Somalia") %>% 
  extract2("geometry")
ggplot() + 
  geom_sf(data = somaliland, alpha = .5, colour = "blue") + 
  geom_sf(data = somalia, alpha = .5, colour = "red")
```

Due to the different sources, the borders around the part that is Somaliland have minor differences. Therefore, I define Somaliland as the intersection of Somalia and Somaliland and Somalia as Somalia without Somaliland.

```{r}
somaliland <- st_intersection(somalia, somaliland)
somalia <- st_difference(somalia, somaliland)
cow_geocode <- 
  cow_geocode %>% 
  mutate(end_year = if_else(country_name == "Somalia",
                            1991,
                            end_year)) %>% 
  rbind(
    st_sf(
      country_name = c("Somalia", "Somaliland"), 
      country = c("Somalia", "Somaliland"), 
      cow_code = c(520, NA_integer_), 
      start_year = 1992, 
      end_year = 2017, 
      geometry = c(somalia, somaliland)
    ) %>% 
      st_transform(crs = st_crs(cow_geocode))
  )
```

## Hongkong

We can find Hong Kong in the states dataset of "Natural Earth".

```{r}
states <- 
  read_sf(
    system.file(
      "extdata", 
      "natural_earth/ne_10m_admin_1_states_provinces.shp", 
      package = "vdem.tectr"
    )
  ) %>% 
  st_transform(crs = st_crs(cow_geocode))
hongkong <- 
  states %>%
  filter(iso_a2 == "HK") %>% 
  extract2("geometry") %>% 
  st_union()
cow_geocode <-
  cow_geocode %>% 
  rbind(
    st_sf(
      country_name = "Hong Kong", 
      country = "Hong Kong", 
      cow_code = NA_integer_, 
      start_year = 1946, 
      end_year = 2017, 
      geometry = hongkong
    )
  )
```

## Palestinian regions

Palestine under the british mandate is coded until 1948 and cooresponded to Israel and Palestine. We will first read in all regions in the area.

```{r}
british_mandate <- 
  cow_geocode %>% 
  filter(country_name == "Israel", end_year == 2017) %>% 
  extract2("geometry")
westbank <- 
  states %>% 
  filter(name == "West Bank") %>% 
  extract2("geometry")
gazastrip <- 
  states %>% 
  filter(name == "Gaza Strip") %>% 
  extract2("geometry")
israels <- 
  cow_geocode %>% 
  filter(country_name == "Israel") %>% 
  arrange(start_year) %>% 
  extract2("geometry") %>% 
  st_difference(st_union(westbank, gazastrip))
cow_geocode %>% 
  filter(country_name == "Israel") %>% 
  ggplot() + 
  geom_sf(fill = "red", alpha = .5) + 
  geom_sf(data = c(westbank, gazastrip), 
          alpha = .5, fill = "blue") + 
  facet_wrap(vars(start_year))
```

According to the country coding document, West Bank refers to both West Bank and Gaza except for 1948 - 1967 and 2007 - 2017 when Gaza is coded separately. We thus implement this:

```{r}
cow_geocode <- 
  cow_geocode %>% 
  filter(country_name != "Israel") %>% 
  rbind(
    st_sf(
      country_name = 
        c("Palestine/British Mandate", 
          "Israel", "Israel", "Israel", 
          "Palestine/West Bank", 
          "Palestine/West Bank", 
          "Palestine/West Bank", 
          "Palestine/Gaza", 
          "Palestine/Gaza"), 
      country = 
        c("Palestine/British Mandate", 
          "Israel", "Israel", "Israel", 
          "Palestine/West Bank", 
          "Palestine/West Bank", 
          "Palestine/West Bank", 
          "Palestine/Gaza", 
          "Palestine/Gaza"), 
      cow_code = c(NA_integer_, rep(666, 3), rep(NA_integer_, 5)),
      start_year = 
        c(1946, 1949, 1968, 1980, 1949, 1968, 2008, 1948, 2007), 
      end_year = 
        c(1948, 1967, 1979, 2017, 1967, 2007, 2017, 1967, 2017), 
      geometry = 
        c(british_mandate, 
          israels, 
          westbank, 
          st_union(westbank, gazastrip), 
          westbank, 
          gazastrip, 
          gazastrip)
    )
  )
```

This concludes the geocoding as all remaining regions have been coded. The country column is superfluous and we therefore delete it.

```{r}
vdem_spatial <- 
  cow_geocode %>% 
  select(-country)
devtools::use_data(vdem_spatial, overwrite = TRUE)
```
